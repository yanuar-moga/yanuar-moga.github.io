import pandas as pd
import tkinter as tk
from tkinter import filedialog, messagebox

# =====================================================
# FUNGSI AUTO-DETECT KOLOM KUNCI
# =====================================================
def detect_key_column(df):
    """
    Mendeteksi kolom kunci secara otomatis.
    Prioritas:
    1. NISN
    2. No Induk / No_Induk
    3. ID
    4. Nama
    """
    priority_keywords = [
        "nisn",
        "no_induk",
        "no induk",
        "id",
        "nama"
    ]

    # 1. Deteksi dari nama header
    for col in df.columns:
        col_lower = col.lower()
        for key in priority_keywords:
            if key in col_lower:
                return col

    # 2. Fallback: kolom dengan teks terbanyak
    best_col = df.columns[0]
    best_score = 0

    for col in df.columns:
        try:
            score = df[col].astype(str).apply(lambda x: x.isalpha()).sum()
            if score > best_score:
                best_score = score
                best_col = col
        except:
            pass

    return best_col


# =====================================================
# APLIKASI GUI
# =====================================================
class ExcelSorterApp:
    def __init__(self, root):
        self.root = root
        root.title("Aplikasi Urutkan Data Excel - by MB")
        root.geometry("500x380")
        root.resizable(False, False)

        self.file_data = None
        self.file_order = None

        tk.Label(
            root,
            text="Aplikasi Urutkan Data Excel",
            font=("Arial", 14, "bold")
        ).pack(pady=10)

        tk.Label(
            root,
            text="by MB",
            font=("Arial", 9)
        ).pack(pady=(0, 15))

        # =====================
        # PILIH FILE DATA
        # =====================
        tk.Button(
            root,
            text="Pilih Excel Data Lengkap",
            width=30,
            command=self.load_data
        ).pack(pady=5)

        self.lbl_data = tk.Label(root, text="Belum dipilih", fg="gray")
        self.lbl_data.pack()

        # =====================
        # PILIH FILE URUTAN
        # =====================
        tk.Button(
            root,
            text="Pilih Excel Urutan",
            width=30,
            command=self.load_order
        ).pack(pady=15)

        self.lbl_order = tk.Label(root, text="Belum dipilih", fg="gray")
        self.lbl_order.pack()

        # =====================
        # PROSES
        # =====================
        tk.Button(
            root,
            text="Proses & Simpan",
            width=30,
            bg="#2563eb",
            fg="white",
            command=self.process
        ).pack(pady=25)

    def load_data(self):
        self.file_data = filedialog.askopenfilename(
            filetypes=[("Excel Files", "*.xlsx *.xls")]
        )
        if self.file_data:
            self.lbl_data.config(
                text=self.file_data.split("/")[-1],
                fg="black"
            )

    def load_order(self):
        self.file_order = filedialog.askopenfilename(
            filetypes=[("Excel Files", "*.xlsx *.xls")]
        )
        if self.file_order:
            self.lbl_order.config(
                text=self.file_order.split("/")[-1],
                fg="black"
            )

    def process(self):
        if not self.file_data or not self.file_order:
            messagebox.showerror(
                "Error",
                "Harap pilih kedua file Excel terlebih dahulu."
            )
            return

        try:
            # Baca file
            df_data = pd.read_excel(self.file_data)
            df_order = pd.read_excel(self.file_order)

            # Deteksi kolom kunci
            key_data = detect_key_column(df_data)
            key_order = detect_key_column(df_order)

            # Normalisasi data
            df_data[key_data] = (
                df_data[key_data]
                .astype(str)
                .str.strip()
                .str.lower()
            )

            df_order[key_order] = (
                df_order[key_order]
                .astype(str)
                .str.strip()
                .str.lower()
            )

            # Urutkan sesuai Excel urutan
            df_result = df_order[[key_order]].merge(
                df_data,
                left_on=key_order,
                right_on=key_data,
                how="left"
            )

            # Simpan hasil
            save_path = filedialog.asksaveasfilename(
                defaultextension=".xlsx",
                filetypes=[("Excel Files", "*.xlsx")],
                initialfile="hasil_urut_siswa.xlsx"
            )

            if save_path:
                df_result.to_excel(save_path, index=False)

                messagebox.showinfo(
                    "Sukses",
                    f"Data berhasil diurutkan!\n\n"
                    f"Kolom acuan terdeteksi:\n"
                    f"- Data Lengkap : {key_data}\n"
                    f"- Data Urutan  : {key_order}"
                )

        except Exception as e:
            messagebox.showerror("Error", str(e))


# =====================================================
# JALANKAN APLIKASI
# =====================================================
if __name__ == "__main__":
    root = tk.Tk()
    app = ExcelSorterApp(root)
    root.mainloop()
