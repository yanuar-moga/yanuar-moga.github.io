<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aplikasi Sinkronisasi Nilai Siswa</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { background: #f3f6fa; }
.step-box { border-left: 5px solid #0d6efd; padding-left: 15px; }
.table td, .table th { text-align:center; vertical-align: middle; }
.header-logo { 
  height: auto; 
  max-height: 80px; /* menyesuaikan tinggi teks header */
  margin-right:15px;
}
.header-desc { font-size: 0.9rem; color:#555; }
.header-version { font-size:0.85rem; color:#888; }
.header-dev { font-size:0.85rem; color:#555; }
.footer { text-align:center; margin-top:30px; font-size:0.85rem; color:#888; }
</style>
</head>
<body class="p-4">

<div class="container">
  <!-- HEADER -->
  <div class="d-flex align-items-center mb-4">
    <img src="assets/mb.png" class="header-logo" />
    <div>
      <h2 class="fw-bold mb-1">Aplikasi Sinkronisasi Nilai Siswa</h2>
      <div class="header-desc">Dari nilai Google Form respons langsung ke rekap daftar nilai Excel</div>
      <div class="header-version">Version 1.0 | Build 23 November 2025</div>
      <div class="header-dev">Developer: MB</div>
    </div>
  </div>

  <!-- INPUT CONFIG -->
  <div class="card shadow-sm mb-4">
    <div class="card-body step-box">
      <h5>Konfigurasi Google Sheet</h5>
      <div class="mb-2">
        <label>Script URL</label>
        <input type="text" id="scriptUrl" class="form-control" placeholder="Masukkan URL WebApp Apps Script">
      </div>
      <div class="mb-2">
        <label>Spreadsheet ID</label>
        <input type="text" id="sheetId" class="form-control" placeholder="Masukkan Spreadsheet ID">
      </div>
      <div class="mb-2">
        <label>Sheet Range</label>
        <input type="text" id="sheetRange" class="form-control" value="Form Responses 1!A1:E400">
      </div>
      <div class="mb-2">
        <label>KKM</label>
        <input type="number" id="kkm" class="form-control" value="78">
      </div>
      <button id="btnLoad" class="btn btn-primary">Load Data</button>
      <div id="loadStatus" class="mt-2 text-secondary"></div>
    </div>
  </div>

  <!-- UPLOAD EXCEL -->
  <div class="card shadow-sm mb-4" id="uploadSection" style="display:none;">
    <div class="card-body step-box">
      <h5>Upload Data Siswa (Excel)</h5>
      <input type="file" id="excelInput" class="form-control" accept=".xlsx,.xls">
      <div id="excelStatus" class="mt-2 text-secondary"></div>
    </div>
  </div>

  <!-- SYNC -->
  <div class="card shadow-sm mb-4" id="syncSection" style="display:none;">
    <div class="card-body step-box">
      <h5>Sinkronisasi Nilai</h5>
      <button id="btnSync" class="btn btn-warning">Sync Nilai</button>
      <div id="syncStatus" class="mt-2 text-secondary"></div>
    </div>
  </div>

  <!-- HASIL -->
  <div class="card shadow-sm mb-4" id="resultSection" style="display:none;">
    <div class="card-body step-box">
      <h5>Hasil Sinkronisasi</h5>
      <table class="table table-bordered" id="resultTable"></table>
      <button id="btnDownload" class="btn btn-success mt-2">Download Excel</button>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    © 2025 MB All Rights Reserved
  </div>
</div>

<script>
let sheetData = [], excelData = [], mergedData = [];

// LOAD DATA GOOGLE SHEET
document.getElementById("btnLoad").onclick = async () => {
  const SCRIPT_URL = document.getElementById("scriptUrl").value.trim();
  const ssId = document.getElementById("sheetId").value.trim();
  const range = document.getElementById("sheetRange").value.trim();

  if(!SCRIPT_URL || !ssId) return alert("Masukkan Script URL dan Spreadsheet ID");

  document.getElementById("loadStatus").innerHTML = "Mengambil data…";

  try {
    const res = await fetch(`${SCRIPT_URL}?id=${ssId}&sheet=${encodeURIComponent(range)}`);
    const json = await res.json();

    if(json.status !== "success") throw json.message;

    sheetData = json.data;
    sheetData.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));

    document.getElementById("loadStatus").innerHTML = `<span class="text-success">Berhasil load ${sheetData.length} data!</span>`;
    document.getElementById("uploadSection").style.display = "block";

  } catch(err) {
    document.getElementById("loadStatus").innerHTML = `<span class="text-danger">Gagal fetch: ${err}</span>`;
  }
};

// UPLOAD EXCEL
document.getElementById("excelInput").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(event){
    const wb = XLSX.read(event.target.result,{type:"binary"});
    const wsName = wb.SheetNames[0];
    const ws = wb.Sheets[wsName];
    excelData = XLSX.utils.sheet_to_json(ws,{header:1});
    document.getElementById("excelStatus").innerHTML = `<span class="text-success">Excel berhasil dibaca (${excelData.length-1} baris)</span>`;
    document.getElementById("syncSection").style.display = "block";
  };
  reader.readAsBinaryString(file);
});

// SYNC DATA
document.getElementById("btnSync").onclick = () => {
  const kkm = Number(document.getElementById("kkm").value);
  mergedData = [];
  const excelRows = excelData.slice(1);

  excelRows.forEach(row => {
    const namaExcel = row[1]?.toString().trim().toLowerCase();
    const kelasExcel = row[2];
    const attempts = sheetData.filter(s => s.nama?.toString().trim().toLowerCase()===namaExcel);
    const scores = attempts.map(a=>Number(a.score)).slice(0,5);
    while(scores.length<5) scores.push("");

    // Aturan Nilai Akhir: jika ada percobaan > KKM selain score1, nilai akhir = KKM
    const overKKM = scores.slice(1).some(n=>n!=="" && n>kkm);
    let scoreAkhir = Math.max(...scores.filter(n=>n!==""));
    if(overKKM) scoreAkhir = kkm;

    mergedData.push({
      no: row[0],
      nama: row[1],
      kelas: kelasExcel,
      score1: scores[0]||"",
      score2: scores[1]||"",
      score3: scores[2]||"",
      score4: scores[3]||"",
      score5: scores[4]||"",
      scoreAkhir: isFinite(scoreAkhir)?scoreAkhir:""
    });
  });

  displayTable(kkm);
};

// DISPLAY TABLE
function displayTable(kkm){
  document.getElementById("resultSection").style.display="block";
  let html=`<tr class='table-primary'>
    <th>No</th><th>Nama</th><th>Kelas</th>
    <th>Score 1</th><th>Score 2</th><th>Score 3</th>
    <th>Score 4</th><th>Score 5</th><th>Nilai Akhir</th>
  </tr>`;
  mergedData.forEach(r=>{
    html+=`<tr>
      <td>${r.no}</td>
      <td>${r.nama}</td>
      <td>${r.kelas}</td>
      ${[r.score1,r.score2,r.score3,r.score4,r.score5].map(s=>{
        let color = s===""?"":(s<kkm?"#f8d7da":s==kkm?"#fff3cd":"#d4edda");
        return `<td style="background:${color}">${s}</td>`;
      }).join("")}
      <td class="fw-bold text-center">${r.scoreAkhir}</td>
    </tr>`;
  });
  document.getElementById("resultTable").innerHTML = html;
  document.getElementById("syncStatus").innerHTML = `<span class="text-success">Sinkronisasi selesai!</span>`;
}

// DOWNLOAD EXCEL
document.getElementById("btnDownload").onclick = ()=>{
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(mergedData);
  XLSX.utils.book_append_sheet(wb,ws,"Hasil Sinkron");
  XLSX.writeFile(wb,"hasil_sinkron.xlsx");
};
</script>

</body>
</html>
