<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Laporan Perkembangan Siswa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    background:#eef2f7;
    margin:0;
    padding:20px;
}
.container{
    max-width:1200px;
    margin:auto;
    background:#fff;
    padding:20px;
    border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,.1);
}
h2,h3{
    margin:10px 0;
}
input[type=file],button{
    padding:8px 12px;
    margin:5px 0;
}
button{
    background:#0d6efd;
    color:#fff;
    border:none;
    border-radius:5px;
    cursor:pointer;
}
button:hover{
    background:#084298;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}
th,td{
    border:1px solid #ccc;
    padding:8px;
    vertical-align:top;
}
th{
    background:#f1f1f1;
}
.badge{
    padding:3px 8px;
    border-radius:4px;
    color:#fff;
    font-size:12px;
}
.good{background:#198754;}
.warn{background:#ffc107;color:#000;}
.bad{background:#dc3545;}

#pdfArea{
    padding:1.5cm;
    box-sizing:border-box;
}
.kop{
    text-align:center;
    border-bottom:3px solid #000;
    padding-bottom:10px;
    margin-bottom:20px;
}
.kop img{
    width:80px;
    position:absolute;
    left:40px;
    top:40px;
}
</style>
</head>

<body>
<div class="container">
    <h2>ðŸ“Š Aplikasi Analisis Perkembangan Siswa</h2>

    <input type="file" id="excelFile" accept=".xlsx,.xls">
    <br>
    <button onclick="processExcel()">Proses Data</button>
    <button onclick="downloadPDF()">Download PDF</button>

    <div id="pdfArea">
        <div class="kop">
            <img src="assets/logo.png">
            <h3>PEMERINTAH KABUPATEN PEMALANG</h3>
            <strong>DINAS PENDIDIKAN DAN KEBUDAYAAN</strong><br>
            PANITIA ASESMEN SUMATIF AKHIR SEMESTER<br>
            <strong>SMP NEGERI 1 MOGA</strong><br>
            TAHUN AJARAN 2025/2026<br>
            <small>Alamat: Jalan Simpang Tiga Telp (0284) 583367 Pemalang 52354</small>
        </div>

        <table id="resultTable">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama Siswa</th>
                    <th>Karakter</th>
                    <th>Kekurangan</th>
                    <th>Perbaikan</th>
                    <th>Profil Pancasila</th>
                    <th>Jawaban untuk Orang Tua</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
function processExcel(){
    const file = document.getElementById("excelFile").files[0];
    if(!file) return alert("Pilih file Excel terlebih dahulu");

    const reader = new FileReader();
    reader.onload = function(e){
        const wb = XLSX.read(e.target.result,{type:"binary"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws,{header:1});

        const tbody = document.querySelector("#resultTable tbody");
        tbody.innerHTML="";

        for(let i=7;i<=38;i++){
            if(!data[i] || !data[i][1]) continue;

            const nama = data[i][1];
            const nilaiMapel = data[i].slice(4,15).filter(n=>!isNaN(n));
            const sakit = data[i][15]||0;
            const izin = data[i][16]||0;
            const alpa = data[i][17]||0;
            const ekskul = data[i].slice(18,25).filter(e=>e);

            const rata = nilaiMapel.reduce((a,b)=>a+b,0)/nilaiMapel.length;

            let karakter = rata>=85 ? "Sangat Baik" : rata>=75 ? "Baik" : "Perlu Bimbingan";

            let kekurangan=[];
            let alasan=[];

            if(alpa>=3 || (sakit+izin+alpa)>=6){
                kekurangan.push("Disiplin");
                alasan.push("Penilaian disiplin didasarkan pada jumlah ketidakhadiran siswa (sakit, izin, dan alpa).");
            }

            if(Math.max(...nilaiMapel)-Math.min(...nilaiMapel)>=15 || ekskul.length>0){
                kekurangan.push("Minat & Bakat");
                alasan.push("Penilaian minat dan bakat didasarkan pada perbedaan capaian nilai mata pelajaran serta keikutsertaan dalam kegiatan ekstrakurikuler.");
            }

            let perbaikan = kekurangan.includes("Disiplin")
                ? "Meningkatkan kedisiplinan hadir dan tanggung jawab belajar."
                : "Mengembangkan potensi sesuai minat dan bakat siswa.";

            let pancasila = "Beriman, Mandiri, Gotong Royong";

            let jawaban = `
<b>Perkembangan:</b> Anak menunjukkan perkembangan ${karakter.toLowerCase()} di sekolah.<br>
<b>Dukungan Orang Tua:</b> Dampingi belajar rutin dan berikan motivasi positif.<br>
<b>Program Tambahan:</b> Disarankan mengikuti kegiatan penguatan akademik dan ekstrakurikuler.
            `;

            tbody.innerHTML+=`
            <tr>
                <td>${i-6}</td>
                <td>${nama}</td>
                <td>${karakter}</td>
                <td>${kekurangan.join(", ") || "-"}</td>
                <td>${perbaikan}<br><small>${alasan.join("<br>")}</small></td>
                <td>${pancasila}</td>
                <td>${jawaban}</td>
            </tr>`;
        }
    };
    reader.readAsBinaryString(file);
}

function downloadPDF(){
    html2pdf().set({
        filename:"Laporan_Perkembangan_Siswa.pdf",
        html2canvas:{scale:1.6,useCORS:true},
        jsPDF:{format:"a4",orientation:"landscape"},
        pagebreak:{mode:['avoid-all','css','legacy']}
    }).from(document.getElementById("pdfArea")).save();
}
</script>
</body>
</html>
