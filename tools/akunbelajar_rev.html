<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pencocokan Akun Belajar Siswa</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    font-family: Segoe UI, Arial;
    background:#f5f8ff;
    margin:0;
    padding:20px;
    transition:.3s;
}
.dark-mode{background:#1e1e1e;color:#fff}
.header{display:flex;align-items:center;gap:15px}
.header img{height:60px;border-radius:10px}

button,select,input{
    padding:6px;
    border-radius:8px;
    border:1px solid #3d6ef7;
    margin:4px;
}
button{background:#3d6ef7;color:#fff;cursor:pointer}
button:hover{background:#244ec4}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #777;padding:6px}

.progress{width:300px;height:14px;background:#ccc;border-radius:10px;overflow:hidden;display:none}
.progress-inner{height:100%;width:0;background:#3d6ef7}

.dark-mode table,.dark-mode th,.dark-mode td{color:white;border-color:#666}
</style>
</head>

<body>

<div class="header">
  <img src="assets/logo.jpg">
  <h2>Aplikasi Pencocokan Akun Belajar Siswa</h2>
</div>

<hr>

<b>Email Guru:</b>
<input id="emailGuru" value="yanuar.bayu62@guru.smp.belajar.id" style="width:280px">

<b>Website:</b>
<input id="webGuru" value="https://tik-smpn1moga.blogspot.com/" style="width:280px">

<br><br>

<button onclick="proses()">üìÇ Load Data</button>
<button onclick="toggleDark()">üåô Dark Mode</button>

<div class="progress" id="progressBar">
  <div class="progress-inner" id="pIn"></div>
</div>

<hr>

<div id="panelKelas" style="display:none">
<b>Muat Data:</b>
<select id="kelasDipilih"></select>
<button onclick="muatData()">üìÇ Muat Data</button>
</div>

<hr>

<button onclick="pilihSemua()">‚úÖ Pilih Semua</button>
<button onclick="hapusPilihan()">‚ùå Hapus Pilihan</button>
<button onclick="downloadExcel()">‚¨á Download Excel</button>
<button onclick="downloadPDF()">‚¨á Cetak Kartu</button>

<div id="status"></div>
<table id="tabelHasil"></table>

<script>
const ID_SISWA = "1o-UJUKgFk1Yzz7UDfyhIDQrDp50apLSlsYKaBbk-_Rk";
const ID_AKUN  = "1kr1awxn3B8io3vyehAMgLgRHHt8JigDZT9zlH3C0kFw";

let dataSiswa=[], dataAkun=[], hasilGabung=[], hasilTampil=[];

function progress(x){
  progressBar.style.display="block";
  pIn.style.width=x+"%";
}

function fetchSheet(id,cb){
 fetch(`https://docs.google.com/spreadsheets/d/${id}/export?format=xlsx`)
 .then(r=>r.arrayBuffer())
 .then(b=>{
   let wb=XLSX.read(b,{type:"array"});
   let ws=wb.Sheets[wb.SheetNames[0]];
   cb(XLSX.utils.sheet_to_json(ws,{header:1}));
 });
}

function proses(){
 progress(20);
 fetchSheet(ID_SISWA,r1=>{
  progress(50);
  fetchSheet(ID_AKUN,r2=>{
    loadSiswa(r1);
    loadAkun(r2);
    cocokkan();
    isiDropdownKelas();
    panelKelas.style.display="block";
    progressBar.style.display="none";
  });
 });
}

function loadSiswa(r){
 dataSiswa=[];
 for(let i=1;i<r.length;i++){
  if(r[i][1] && r[i][2]){
   dataSiswa.push({
    nama:r[i][1].toString().trim().toLowerCase(),
    tampil:r[i][1].toString().trim(),
    kelas:r[i][2].toString().trim()
   });
  }
 }
}

function loadAkun(r){
 dataAkun=[];
 for(let i=1;i<r.length;i++){
  if(r[i][8]){
   dataAkun.push({
    nama:r[i][8].toString().trim().toLowerCase(),
    akun:r[i][7]||"",
    pass:r[i][14]||""
   });
  }
 }
}

function cocokkan(){
 hasilGabung=[];
 let tanpa=0;
 dataSiswa.forEach(s=>{
  let a=dataAkun.find(x=>x.nama===s.nama);
  if(!a) tanpa++;
  hasilGabung.push({
   cek:false,
   Nama:s.tampil,
   Kelas:s.kelas,
   Akun:a?a.akun:"",
   Password:a?a.pass:""
  });
 });
 status.innerHTML=`Total: ${hasilGabung.length} | Tanpa Akun: ${tanpa}`;
}

function isiDropdownKelas(){
 kelasDipilih.innerHTML=`<option value="all">üìÅ Semua Kelas</option>`;
 [...new Set(hasilGabung.map(x=>x.Kelas))].sort().forEach(k=>{
  let o=document.createElement("option");
  o.value=k;o.textContent="Kelas "+k;
  kelasDipilih.appendChild(o);
 });
}

function muatData(){
 let k=kelasDipilih.value;
 hasilTampil = k==="all"?hasilGabung:hasilGabung.filter(x=>x.Kelas===k);
 tampil();
}

function tampil(){
 let h=`<tr>
 <th>Pilih</th><th>Nama</th><th>Kelas</th><th>Username</th><th>Password</th>
 </tr>`;
 hasilTampil.forEach(r=>{
  h+=`<tr>
  <td><input type="checkbox" ${r.cek?"checked":""} onclick="r.cek=!r.cek"></td>
  <td>${r.Nama}</td><td>${r.Kelas}</td><td>${r.Akun}</td><td>${r.Password}</td>
  </tr>`;
 });
 tabelHasil.innerHTML=h;
}

function pilihSemua(){hasilTampil.forEach(r=>r.cek=true);tampil();}
function hapusPilihan(){hasilTampil.forEach(r=>r.cek=false);tampil();}

function downloadExcel(){
 let p=hasilGabung.filter(x=>x.cek);
 if(!p.length) return alert("Pilih data dulu");
 let ws=XLSX.utils.json_to_sheet(p.map(x=>({
  Nama:x.Nama,Kelas:x.Kelas,Username:x.Akun,Password:x.Password
 })));
 let wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Data");
 XLSX.writeFile(wb,"Akun_Belajar.xlsx");
}

/* ===== PDF FIX TOTAL (ANTI NUMPAK) ===== */
function downloadPDF(){
 const {jsPDF}=window.jspdf;
 let doc=new jsPDF("p","mm","a4");
 doc.setFontSize(10);

 let data=hasilGabung.filter(x=>x.cek);
 if(!data.length) return alert("Pilih data dulu");

 let cardW=90, cardH=45;
 let startX=10, startY=10;
 let gapX=5, gapY=6;

 data.forEach((r,i)=>{
  let col=i%2;
  let row=Math.floor(i/2);

  let x=startX+(cardW+gapX)*col;
  let y=startY+(cardH+gapY)*row;

  if(y>260){ doc.addPage(); y=10; }

  doc.rect(x,y,cardW,cardH);

  let labelX=x+4;
  let colonX=x+30;
  let valueX=x+34;
  let maxW=cardW-38;
  let lineY=y+8;

  function rowText(label,value){
    doc.text(label,labelX,lineY);
    doc.text(":",colonX,lineY);
    let t=doc.splitTextToSize(value,maxW);
    doc.text(t,valueX,lineY);
    lineY+=t.length*5;
  }

  rowText("Nama",r.Nama);
  rowText("Kelas",r.Kelas);
  rowText("Username",r.Akun);
  rowText("Password",r.Password);
  rowText("Email Guru",emailGuru.value);
  rowText("Website",webGuru.value);
 });

 doc.save("Kartu_Login.pdf");
}

function toggleDark(){
 document.body.classList.toggle("dark-mode");
}
</script>

</body>
</html>
