<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pencocokan Akun Belajar</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Segoe UI;background:#f4f7ff;padding:20px}
button,select,input{
 padding:8px 12px;border-radius:10px;border:none;
 background:#4f6ef7;color:white;font-weight:600;margin:4px;cursor:pointer
}
select{background:white;color:#333;border:2px solid #4f6ef7}
table{border-collapse:collapse;width:100%;margin-top:15px}
th,td{border:1px solid #aaa;padding:6px}
.dark{background:#1e1e1e;color:white}
</style>
</head>

<body>

<h2>ğŸ“˜ Aplikasi Pencocokan Akun Belajar</h2>

<button onclick="mulai()">ğŸ” Cocokkan</button>
<button onclick="document.body.classList.toggle('dark')">ğŸŒ™ Dark Mode</button>

<hr>

<div id="menuLoad" style="display:none">
<b>Muat Data:</b>
<button onclick="loadSemua()">ğŸ“‚ Semua Kelas</button>

<select id="kelasPilih"></select>
<button onclick="loadPerKelas()">ğŸ“ Muat Kelas</button>
</div>

<hr>

<button onclick="pilihSemua()">âœ… Pilih Semua</button>
<button onclick="hapusPilihan()">âŒ Hapus Pilihan</button>
<button onclick="downloadExcel()">â¬‡ Download Excel</button>
<button onclick="downloadPDF()">â¬‡ Cetak Kartu</button>

<div id="info"></div>
<table id="tabel"></table>

<script>
const ID_SISWA="1o-UJUKgFk1Yzz7UDfyhIDQrDp50apLSlsYKaBbk-_Rk";
const ID_AKUN ="1kr1awxn3B8io3vyehAMgLgRHHt8JigDZT9zlH3C0kFw";

let dataSiswa=[],dataAkun=[],hasil=[],tampilData=[];

function ambilSheet(id,cb){
 fetch(`https://docs.google.com/spreadsheets/d/${id}/export?format=xlsx`)
 .then(r=>r.arrayBuffer())
 .then(b=>{
  let wb=XLSX.read(b,{type:"array"});
  cb(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1}));
 });
}

function mulai(){
 ambilSheet(ID_SISWA,s=>{
  dataSiswa=[];
  for(let i=1;i<s.length;i++){
   if(s[i][1]&&s[i][2]){
    dataSiswa.push({
     nama:s[i][1].toLowerCase().trim(),
     tampil:s[i][1],
     kelas:s[i][2]
    });
   }
  }
  ambilSheet(ID_AKUN,a=>{
   dataAkun=[];
   for(let i=1;i<a.length;i++){
    if(a[i][8]){
     dataAkun.push({
      nama:a[i][8].toLowerCase().trim(),
      akun:a[i][7]||"",
      pass:a[i][14]||""
     });
    }
   }
   cocokkan();
  });
 });
}

function cocokkan(){
 hasil=[];
 dataSiswa.forEach(s=>{
  let a=dataAkun.find(x=>x.nama===s.nama);
  hasil.push({
   cek:false,
   Nama:s.tampil,
   Kelas:s.kelas,
   Username:a?a.akun:"",
   Password:a?a.pass:""
  });
 });

 let kelas=[...new Set(hasil.map(x=>x.Kelas))].sort();
 kelasPilih.innerHTML="";
 kelas.forEach(k=>{
  let o=document.createElement("option");
  o.value=k;o.textContent=k;
  kelasPilih.appendChild(o);
 });

 menuLoad.style.display="block";
}

function loadSemua(){ tampilkan(hasil) }
function loadPerKelas(){
 let k=kelasPilih.value;
 tampilkan(hasil.filter(x=>x.Kelas===k));
}

function tampilkan(data){
 tampilData=data;
 let h="<tr><th>Pilih</th><th>Nama</th><th>Kelas</th><th>Username</th><th>Password</th></tr>";
 data.forEach((r,i)=>{
  h+=`<tr>
  <td><input type="checkbox" ${r.cek?"checked":""}
      onclick="tampilData[${i}].cek=!tampilData[${i}].cek"></td>
  <td>${r.Nama}</td>
  <td>${r.Kelas}</td>
  <td>${r.Username}</td>
  <td>${r.Password}</td>
  </tr>`;
 });
 tabel.innerHTML=h;
 info.innerHTML=`<b>Jumlah data:</b> ${data.length}`;
}

function pilihSemua(){tampilData.forEach(x=>x.cek=true);tampilkan(tampilData)}
function hapusPilihan(){tampilData.forEach(x=>x.cek=false);tampilkan(tampilData)}

function downloadExcel(){
 let data=tampilData.filter(x=>x.cek);
 if(!data.length){alert("Tidak ada data dipilih");return;}
 let ws=XLSX.utils.json_to_sheet(data.map(x=>({
  Nama:x.Nama,Kelas:x.Kelas,Username:x.Username,Password:x.Password
 })));
 let wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Data");
 XLSX.writeFile(wb,"akun_belajar.xlsx");
}

function downloadPDF(){
 let data=tampilData.filter(x=>x.cek);
 if(!data.length){alert("Tidak ada data dipilih");return;}
 const {jsPDF}=window.jspdf;
 let pdf=new jsPDF();
 let y=10;
 data.forEach((s,i)=>{
  pdf.text(`Nama     : ${s.Nama}`,10,y);y+=7;
  pdf.text(`Kelas    : ${s.Kelas}`,10,y);y+=7;
  pdf.text(`Username : ${s.Username}`,10,y);y+=7;
  pdf.text(`Password : ${s.Password}`,10,y);y+=10;
  if(y>270){pdf.addPage();y=10;}
 });
 pdf.save("kartu_akun_belajar.pdf");
}
</script>

</body>
</html>
