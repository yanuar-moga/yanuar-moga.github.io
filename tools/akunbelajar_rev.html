<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pencocokan Akun Belajar Siswa</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Segoe UI,Arial;background:#f5f8ff;padding:20px}
.dark-mode{background:#1e1e1e;color:white}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #777;padding:6px}
button,select{padding:6px 10px;border-radius:8px;border:1px solid #3d6ef7}
button{background:#3d6ef7;color:white;cursor:pointer}
</style>
</head>

<body>

<h2>Aplikasi Pencocokan Akun Belajar</h2>

<button onclick="proses()">üîç Cocokkan</button>
<button onclick="toggleDark()">üåô Dark Mode</button>

<br><br>

<b>Filter Kelas:</b>
<select id="filterKelas" onchange="filterKelas()">
<option value="all">Semua Kelas</option>
</select>

<button onclick="pilihSemua()">‚úÖ Pilih Semua</button>

<br><br>
<div id="status"></div>
<table id="tabelHasil"></table>

<script>
const ID_SISWA = "1o-UJUKgFk1Yzz7UDfyhIDQrDp50apLSlsYKaBbk-_Rk";
const ID_AKUN  = "1kr1awxn3B8io3vyehAMgLgRHHt8JigDZT9zlH3C0kFw";

let dataSiswa=[], dataAkun=[], hasilGabung=[], hasilFiltered=[];

function fetchSheet(id,cb){
 fetch(`https://docs.google.com/spreadsheets/d/${id}/export?format=xlsx`)
 .then(r=>r.arrayBuffer())
 .then(b=>{
   let wb=XLSX.read(b,{type:"array"});
   let ws=wb.Sheets[wb.SheetNames[0]];
   cb(XLSX.utils.sheet_to_json(ws,{header:1}));
 });
}

function proses(){
 fetchSheet(ID_SISWA,rows1=>{
   loadSiswa(rows1);
   fetchSheet(ID_AKUN,rows2=>{
     loadAkun(rows2);
     cocokkan();
     tampil(hasilGabung);
     isiKelas();
   });
 });
}

/* ===== DATA SISWA ===== */
/* Nama = kolom B (1) */
/* Rombel = kolom C (2) */
function loadSiswa(rows){
 dataSiswa=[];
 for(let i=1;i<rows.length;i++){
   if(rows[i][1] && rows[i][2]){
     dataSiswa.push({
       nama: rows[i][1].toString().trim().toLowerCase(),
       tampil: rows[i][1],
       kelas: rows[i][2]
     });
   }
 }
}

/* ===== DATA AKUN ===== */
/* Nama = kolom I (8) */
/* Username = kolom H (7) */
/* Password = kolom O (14) */
function loadAkun(rows){
 dataAkun=[];
 for(let i=1;i<rows.length;i++){
   if(rows[i][8]){
     dataAkun.push({
       nama: rows[i][8].toString().trim().toLowerCase(),
       akun: rows[i][7] || "",
       pass: rows[i][14] || ""
     });
   }
 }
}

function cocokkan(){
 hasilGabung=[];
 let tanpa=0;

 dataSiswa.forEach(s=>{
   let a=dataAkun.find(x=>x.nama===s.nama);
   if(!a) tanpa++;

   hasilGabung.push({
     cek:false,
     Nama:s.tampil,
     Kelas:s.kelas,
     Akun:a?a.akun:"",
     Password:a?a.pass:""
   });
 });

 status.innerHTML=
 `Total: ${hasilGabung.length} |
 Tidak Punya Akun: ${tanpa}`;
}

function tampil(list){
 hasilFiltered=list;
 let h="<tr><th>Pilih</th><th>Nama</th><th>Kelas</th><th>Username</th><th>Password</th></tr>";
 list.forEach((r,i)=>{
  h+=`<tr>
   <td><input type="checkbox" ${r.cek?"checked":""} onclick="toggle(${i})"></td>
   <td>${r.Nama}</td>
   <td>${r.Kelas}</td>
   <td>${r.Akun}</td>
   <td>${r.Password}</td>
  </tr>`;
 });
 tabelHasil.innerHTML=h;
}

function toggle(i){hasilFiltered[i].cek=!hasilFiltered[i].cek;}

function isiKelas(){
 filterKelas.innerHTML='<option value="all">Semua Kelas</option>';
 [...new Set(hasilGabung.map(x=>x.Kelas))].sort().forEach(k=>{
   let o=document.createElement("option");
   o.value=k;o.textContent=k;
   filterKelas.appendChild(o);
 });
}

function filterKelas(){
 let k=filterKelas.value;
 if(k==="all") tampil(hasilGabung);
 else tampil(hasilGabung.filter(x=>x.Kelas==k));
}

function pilihSemua(){
 hasilFiltered.forEach(x=>x.cek=true);
 tampil(hasilFiltered);
}

function toggleDark(){
 document.body.classList.toggle("dark-mode");
}
</script>

</body>
</html>
