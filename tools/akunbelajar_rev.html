<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pencocokan Akun Belajar Siswa</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    font-family: Segoe UI, Arial;
    background:#f5f8ff;
    margin:0;
    padding:20px;
    color:#1a1a1a;
    transition:0.3s;
}
.dark-mode{background:#1e1e1e;color:white;}
.header{display:flex;align-items:center;gap:15px;}
.header img{height:60px;border-radius:10px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #888;padding:6px;}
button,select,input{
    padding:6px;margin:5px;border-radius:8px;
    border:1px solid #3d6ef7;
}
button{background:#3d6ef7;color:white;cursor:pointer;}
button:hover{background:#244ec4;}
.progress{
    width:300px;height:15px;background:#ddd;
    border-radius:10px;overflow:hidden;
    margin-top:10px;display:none;
}
.progress-inner{height:100%;width:0;background:#3d6ef7;}
.dark-mode .progress{background:#444;}
.dark-mode td,.dark-mode th{color:white;border-color:#666;}
.card{
    padding:10px;background:white;
    border-radius:10px;
    box-shadow:0 0 10px rgba(0,0,0,.1);
}
.dark-mode .card{background:#2b2b2b;}
</style>
</head>

<body>

<div class="header">
    <img src="assets/logo.jpg">
    <h2>Aplikasi Pencocokan Akun Belajar Siswa</h2>
</div>

<b>Email Guru:</b>
<input id="emailGuru" value="yanuar.bayu62@guru.smp.belajar.id" style="width:280px">

<b>Website:</b>
<input id="webGuru" value="https://tik-smpn1moga.blogspot.com/" style="width:280px">

<br><br>

<button onclick="proses()">üîç Cocokkan</button>
<button onclick="toggleDark()">üåô Dark Mode</button>

<div class="progress" id="progressBar">
    <div class="progress-inner" id="pIn"></div>
</div>

<br>
<b>Filter Kelas:</b>
<select id="filterKelas" onchange="filterKelas()">
    <option value="all">Semua Kelas</option>
</select>

<button onclick="pilihSemua()">‚úÖ Pilih Semua</button>
<button onclick="hapusPilihan()">‚ùå Hapus Pilihan</button>
<button onclick="downloadExcel()">‚¨á Download Excel</button>
<button onclick="downloadPDF()">‚¨á Cetak Kartu</button>

<br><br>
<div id="status"></div>

<table id="tabelHasil"></table>

<script>
const ID_SISWA = "1o-UJUKgFk1Yzz7UDfyhIDQrDp50apLSlsYKaBbk-_Rk";
const ID_AKUN  = "1kr1awxn3B8io3vyehAMgLgRHHt8JigDZT9zlH3C0kFw";

let dataSiswa=[];
let dataAkun=[];
let hasilGabung=[];
let hasilFiltered=[];

function progress(v){
    progressBar.style.display="block";
    pIn.style.width=v+"%";
}

function loadSheet(id,cb){
    fetch(`https://docs.google.com/spreadsheets/d/${id}/export?format=xlsx`)
    .then(r=>r.arrayBuffer())
    .then(b=>{
        let wb=XLSX.read(b,{type:"array"});
        let ws=wb.Sheets[wb.SheetNames[0]];
        cb(XLSX.utils.sheet_to_json(ws,{header:1}));
    });
}

function proses(){
    progress(10);
    loadSheet(ID_SISWA,rows1=>{
        progress(40);
        loadSheet(ID_AKUN,rows2=>{
            progress(70);
            loadSiswa(rows1);
            loadAkun(rows2);
            cocokkan();
            tampil(hasilGabung);
            isiKelas();
            progress(100);
            setTimeout(()=>progressBar.style.display="none",500);
        });
    });
}

function loadSiswa(rows){
    dataSiswa=[];
    for(let i=1;i<rows.length;i++){
        if(rows[i][1]){
            dataSiswa.push({
                nama:rows[i][1].toString().trim().toLowerCase(),
                tampil_nama:rows[i][1],
                kelas:rows[i][2]
            });
        }
    }
}

function loadAkun(rows){
    dataAkun=[];
    for(let i=1;i<rows.length;i++){
        if(rows[i][8]){
            dataAkun.push({
                nama:rows[i][8].toString().trim().toLowerCase(),
                akun:rows[i][7],
                pass:rows[i][14]
            });
        }
    }
}

function cocokkan(){
    hasilGabung=[];
    let tanpa=0;
    dataSiswa.forEach(s=>{
        let a=dataAkun.find(x=>x.nama===s.nama);
        if(!a) tanpa++;
        hasilGabung.push({
            cek:false,
            Nama:s.tampil_nama,
            Kelas:s.kelas,
            Akun:a?a.akun:"",
            Password:a?a.pass:""
        });
    });
    status.innerHTML=
        `<b>Total siswa:</b> ${hasilGabung.length} |
         <b>Tidak punya akun:</b> ${tanpa}`;
}

function tampil(list){
    hasilFiltered=list;
    let h=`<tr>
        <th>Pilih</th>
        <th>Nama</th>
        <th>Kelas</th>
        <th>Username</th>
        <th>Password</th>
    </tr>`;
    list.forEach(r=>{
        h+=`<tr>
            <td>
                <input type="checkbox" ${r.cek?"checked":""}
                onchange="r.cek=this.checked">
            </td>
            <td>${r.Nama}</td>
            <td>${r.Kelas}</td>
            <td>${r.Akun}</td>
            <td>${r.Password}</td>
        </tr>`;
    });
    tabelHasil.innerHTML=h;
}

function isiKelas(){
    filterKelas.innerHTML=`<option value="all">Semua Kelas</option>`;
    [...new Set(hasilGabung.map(x=>x.Kelas))].forEach(k=>{
        let o=document.createElement("option");
        o.value=k;
        o.textContent=k;
        filterKelas.appendChild(o);
    });
}

function filterKelas(){
    let k=filterKelas.value;
    if(k==="all"){
        tampil(hasilGabung);
    }else{
        tampil(hasilGabung.filter(x=>x.Kelas==k));
    }
}

function pilihSemua(){
    hasilFiltered.forEach(x=>x.cek=true);
    tampil(hasilFiltered);
}

function hapusPilihan(){
    hasilFiltered.forEach(x=>x.cek=false);
    tampil(hasilFiltered);
}

function downloadExcel(){
    let pilih=hasilGabung.filter(x=>x.cek);
    if(!pilih.length){
        alert("Pilih data dulu");
        return;
    }
    let ws=XLSX.utils.json_to_sheet(
        pilih.map(r=>({
            Nama:r.Nama,
            Kelas:r.Kelas,
            Username:r.Akun,
            Password:r.Password
        }))
    );
    let wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Sheet1");
    XLSX.writeFile(wb,"Hasil_Pencocokan.xlsx");
}

function downloadPDF(){
    const {jsPDF}=window.jspdf;
    let doc=new jsPDF("p","mm","a4");
    let pilih=hasilGabung.filter(x=>x.cek);
    if(!pilih.length){
        alert("Pilih data dulu");
        return;
    }
    let y=10;
    pilih.forEach(r=>{
        doc.text(`Nama: ${r.Nama}`,10,y);y+=6;
        doc.text(`Kelas: ${r.Kelas}`,10,y);y+=6;
        doc.text(`Username: ${r.Akun}`,10,y);y+=6;
        doc.text(`Password: ${r.Password}`,10,y);y+=10;
        if(y>280){
            doc.addPage();
            y=10;
        }
    });
    doc.save("Kartu_Login.pdf");
}

function toggleDark(){
    document.body.classList.toggle("dark-mode");
}
</script>

</body>
</html>
