<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pencocokan Akun Belajar Siswa</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    font-family: Segoe UI, Arial;
    background:#f5f8ff;
    margin:0;
    padding:20px;
    transition:.3s;
}
.dark-mode{background:#1e1e1e;color:#fff}
.header{display:flex;align-items:center;gap:15px}
.header img{height:60px;border-radius:10px}

button,select,input{
    padding:6px;
    border-radius:8px;
    border:1px solid #3d6ef7;
    margin:4px;
}
button{background:#3d6ef7;color:#fff;cursor:pointer}
button:hover{background:#244ec4}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #777;padding:6px}

.progress{width:300px;height:14px;background:#ccc;border-radius:10px;overflow:hidden;display:none}
.progress-inner{height:100%;width:0;background:#3d6ef7}

.dark-mode table,.dark-mode th,.dark-mode td{color:white;border-color:#666}
</style>
</head>

<body>

<div class="header">
  <img src="assets/logo.jpg">
  <h2>Aplikasi Pencocokan Akun Belajar Siswa</h2>
</div>

<hr>

<label>Upload Data Siswa</label><br>
<input type="file" id="fileSiswa"><br><br>

<label>Upload Data Akun Belajar</label><br>
<input type="file" id="fileAkun"><br><br>

<b>Email Guru:</b>
<input id="emailGuru" value="yanuar.bayu62@guru.smp.belajar.id" style="width:280px">

<b>Website:</b>
<input id="webGuru" value="https://tik-smpn1moga.blogspot.com/" style="width:280px">

<br><br>

<button onclick="proses()">üîç Load Data</button>
<button onclick="toggleDark()">üåô Dark Mode</button>

<div class="progress" id="progressBar">
  <div class="progress-inner" id="pIn"></div>
</div>

<hr>

<div id="panelKelas" style="display:none">
<b>Muat Data:</b>
<select id="kelasDipilih"></select>
<button onclick="muatData()">üìÇ Muat Data</button>
</div>

<hr>

<button onclick="pilihSemua()">‚úÖ Pilih Semua</button>
<button onclick="hapusPilihan()">‚ùå Hapus Pilihan</button>
<button onclick="downloadExcel()">‚¨á Download Excel</button>
<button onclick="downloadPDF()">‚¨á Cetak Kartu</button>

<div id="status"></div>
<table id="tabelHasil"></table>

<script>
let dataSiswa=[],dataAkun=[],hasilGabung=[],hasilTampil=[];

function progress(x){
  progressBar.style.display="block";
  pIn.style.width=x+"%";
}

function readFile(f,cb){
 let r=new FileReader();
 r.onload=e=>{
   let wb=XLSX.read(e.target.result,{type:"binary"});
   cb(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1}));
 };
 r.readAsBinaryString(f);
}

function proses(){
 if(!fileSiswa.files[0]||!fileAkun.files[0]) return alert("Upload file dulu");
 progress(20);
 readFile(fileSiswa.files[0],r1=>{
  progress(50);
  readFile(fileAkun.files[0],r2=>{
    loadSiswa(r1);
    loadAkun(r2);
    cocokkan();
    isiDropdownKelas();
    panelKelas.style.display="block";
    progressBar.style.display="none";
  });
 });
}

function loadSiswa(r){
 dataSiswa=[];
 for(let i=1;i<r.length;i++){
  if(r[i][1]&&r[i][2]){
   dataSiswa.push({
    nama:r[i][1].toString().trim().toLowerCase(),
    tampil:r[i][1],
    kelas:r[i][2].toString().trim()
   });
  }
 }
}

function loadAkun(r){
 dataAkun=[];
 for(let i=1;i<r.length;i++){
  if(r[i][8]){
   dataAkun.push({
    nama:r[i][8].toString().trim().toLowerCase(),
    akun:r[i][7],
    pass:r[i][14]
   });
  }
 }
}

function cocokkan(){
 hasilGabung=[];
 let tanpa=0;
 dataSiswa.forEach(s=>{
  let a=dataAkun.find(x=>x.nama===s.nama);
  if(!a) tanpa++;
  hasilGabung.push({
   cek:false,
   Nama:s.tampil,
   Kelas:s.kelas,
   Akun:a?a.akun:"",
   Password:a?a.pass:""
  });
 });
 status.innerHTML=`Total: ${hasilGabung.length} | Tanpa Akun: ${tanpa}`;
}

function isiDropdownKelas(){
 let d=kelasDipilih;
 d.innerHTML=`<option value="all">üìÅ Semua Kelas</option>`;
 [...new Set(hasilGabung.map(x=>x.Kelas))].sort().forEach(k=>{
  let o=document.createElement("option");
  o.value=k;o.textContent="Kelas "+k;
  d.appendChild(o);
 });
}

function muatData(){
 let k=kelasDipilih.value;
 hasilTampil = k==="all"?hasilGabung:hasilGabung.filter(x=>x.Kelas===k);
 tampil();
}

function tampil(){
 let t=tabelHasil;
 let h=`<tr>
 <th>Pilih</th><th>Nama</th><th>Kelas</th><th>Username</th><th>Password</th>
 </tr>`;
 hasilTampil.forEach((r,i)=>{
  h+=`<tr>
  <td><input type="checkbox" ${r.cek?"checked":""} onclick="r.cek=!r.cek"></td>
  <td>${r.Nama}</td><td>${r.Kelas}</td><td>${r.Akun}</td><td>${r.Password}</td>
  </tr>`;
 });
 t.innerHTML=h;
}

function pilihSemua(){hasilTampil.forEach(r=>r.cek=true);tampil();}
function hapusPilihan(){hasilTampil.forEach(r=>r.cek=false);tampil();}

function downloadExcel(){
 let p=hasilGabung.filter(x=>x.cek);
 if(!p.length) return alert("Pilih data dulu");
 let ws=XLSX.utils.json_to_sheet(p.map(x=>({
  Nama:x.Nama,Kelas:x.Kelas,Username:x.Akun,Password:x.Password
 })));
 let wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Data");
 XLSX.writeFile(wb,"Akun_Belajar.xlsx");
}

function downloadPDF(){
 const {jsPDF}=window.jspdf;
 let doc=new jsPDF();
 let p=hasilGabung.filter(x=>x.cek);
 if(!p.length) return alert("Pilih data dulu");

 let x=10,y=10,w=90,h=45;
 p.forEach((r,i)=>{
  doc.rect(x,y,w,h);
  doc.text(`Nama : ${r.Nama}`,x+4,y+8);
  doc.text(`Kelas : ${r.Kelas}`,x+4,y+14);
  doc.text(`Username : ${r.Akun}`,x+4,y+20);
  doc.text(`Password : ${r.Password}`,x+4,y+26);
  doc.text(`Email Guru : ${emailGuru.value}`,x+4,y+32);
  doc.text(`Website : ${webGuru.value}`,x+4,y+38);
  x+=w+5;
  if((i+1)%2==0){x=10;y+=h+6}
  if(y>270){doc.addPage();x=10;y=10}
 });
 doc.save("Kartu_Login.pdf");
}

function toggleDark(){document.body.classList.toggle("dark-mode")}
</script>

</body>
</html>
