<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pencocokan Akun Belajar Siswa</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    font-family: Segoe UI, Arial;
    background:#f5f8ff;
    margin:0;
    padding:20px;
    color:#1a1a1a;
}
.dark-mode{background:#1e1e1e;color:white}
.header{display:flex;align-items:center;gap:15px}
.header img{height:60px;border-radius:10px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #888;padding:6px}
button,select,input{padding:6px;margin:5px;border-radius:8px;border:1px solid #3d6ef7}
button{background:#3d6ef7;color:white;cursor:pointer}
button:hover{background:#244ec4}
.progress{width:300px;height:15px;background:#ddd;border-radius:10px;overflow:hidden;display:none}
.progress-inner{height:100%;width:0;background:#3d6ef7}
.dark-mode .progress{background:#444}
</style>
</head>

<body>

<div class="header">
    <img src="assets/logo.jpg">
    <h2>Aplikasi Pencocokan Akun Belajar Siswa</h2>
</div>

<b>Email Guru:</b>
<input id="emailGuru" value="yanuar.bayu62@guru.smp.belajar.id" style="width:280px">
<b>Website:</b>
<input id="webGuru" value="https://tik-smpn1moga.blogspot.com/" style="width:280px">

<br><br>

<button onclick="mulai()">üîç Cocokkan</button>
<button onclick="toggleDark()">üåô Dark Mode</button>

<div class="progress" id="progressBar">
  <div class="progress-inner" id="pIn"></div>
</div>

<!-- PILIHAN SETELAH LOAD -->
<div id="pilihanLoad" style="display:none;margin-top:15px">
  <b>Muat Data:</b>
  <button onclick="loadSemua()">üìÇ Semua Kelas</button>
  <select id="kelasPilih"></select>
  <button onclick="loadPerKelas()">üìÅ Muat Kelas</button>
</div>

<br>

<b>Filter Kelas:</b>
<select id="filterKelas" onchange="filterKelas()">
<option value="all">Semua Kelas</option>
</select>

<button onclick="pilihSemua()">‚úÖ Pilih Semua</button>
<button onclick="hapusPilihan()">‚ùå Hapus Pilihan</button>
<button onclick="downloadExcel()">‚¨á Download Excel</button>
<button onclick="downloadPDF()">‚¨á Cetak Kartu</button>

<br><br>
<div id="status"></div>
<table id="tabelHasil"></table>

<script>
const ID_SISWA="1o-UJUKgFk1Yzz7UDfyhIDQrDp50apLSlsYKaBbk-_Rk";
const ID_AKUN="1kr1awxn3B8io3vyehAMgLgRHHt8JigDZT9zlH3C0kFw";

let dataSiswa=[],dataAkun=[],hasilGabung=[],hasilFiltered=[];

function progress(v){
 progressBar.style.display="block";
 pIn.style.width=v+"%";
}

function fetchSheet(id,cb){
 fetch(`https://docs.google.com/spreadsheets/d/${id}/export?format=xlsx`)
 .then(r=>r.arrayBuffer())
 .then(b=>{
   let wb=XLSX.read(b,{type:"array"});
   cb(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1}));
 });
}

function mulai(){
 progress(10);
 fetchSheet(ID_SISWA,r1=>{
   progress(40);
   loadSiswa(r1);
   fetchSheet(ID_AKUN,r2=>{
     progress(70);
     loadAkun(r2);
     cocokkan();
     tampilPilihan();
     progressBar.style.display="none";
   });
 });
}

function loadSiswa(rows){
 dataSiswa=[];
 for(let i=1;i<rows.length;i++){
   if(rows[i][1] && rows[i][2]){
     dataSiswa.push({
       nama:rows[i][1].toString().trim().toLowerCase(),
       tampil:rows[i][1].toString().trim(),
       kelas:rows[i][2].toString().trim()
     });
   }
 }
}

function loadAkun(rows){
 dataAkun=[];
 for(let i=1;i<rows.length;i++){
   if(rows[i][8]){
     dataAkun.push({
       nama:rows[i][8].toString().trim().toLowerCase(),
       akun:rows[i][7]||"",
       pass:rows[i][14]||""
     });
   }
 }
}

function cocokkan(){
 hasilGabung=[];
 dataSiswa.forEach(s=>{
   let a=dataAkun.find(x=>x.nama===s.nama);
   hasilGabung.push({
     cek:false,
     Nama:s.tampil,
     Kelas:s.kelas,
     Akun:a?a.akun:"",
     Password:a?a.pass:""
   });
 });
}

function tampilPilihan(){
 pilihanLoad.style.display="block";
 kelasPilih.innerHTML="";
 [...new Set(hasilGabung.map(x=>x.Kelas))].sort().forEach(k=>{
   let o=document.createElement("option");
   o.value=k;o.textContent=k;
   kelasPilih.appendChild(o);
 });
}

function loadSemua(){
 tampil(hasilGabung);
 isiFilter();
}

function loadPerKelas(){
 let k=kelasPilih.value;
 tampil(hasilGabung.filter(x=>x.Kelas===k));
 isiFilter();
}

function tampil(list){
 hasilFiltered=list;
 let h="<tr><th>Pilih</th><th>Nama</th><th>Kelas</th><th>Username</th><th>Password</th></tr>";
 list.forEach((r,i)=>{
   h+=`<tr>
   <td><input type="checkbox" ${r.cek?"checked":""} onclick="hasilFiltered[${i}].cek=!hasilFiltered[${i}].cek"></td>
   <td>${r.Nama}</td>
   <td>${r.Kelas}</td>
   <td>${r.Akun}</td>
   <td>${r.Password}</td>
   </tr>`;
 });
 tabelHasil.innerHTML=h;
 status.innerHTML=`<b>Jumlah tampil:</b> ${list.length}`;
}

function isiFilter(){
 filterKelas.innerHTML='<option value="all">Semua Kelas</option>';
 [...new Set(hasilGabung.map(x=>x.Kelas))].sort().forEach(k=>{
   let o=document.createElement("option");
   o.value=k;o.textContent=k;
   filterKelas.appendChild(o);
 });
}

function filterKelas(){
 let k=filterKelas.value;
 if(k==="all") tampil(hasilGabung);
 else tampil(hasilGabung.filter(x=>x.Kelas===k));
}

function pilihSemua(){hasilFiltered.forEach(x=>x.cek=true);tampil(hasilFiltered)}
function hapusPilihan(){hasilFiltered.forEach(x=>x.cek=false);tampil(hasilFiltered)}
function toggleDark(){document.body.classList.toggle("dark-mode")}
</script>

</body>
</html>
