<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Aplikasi Penilaian Karakter Siswa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBRARY -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #eef2f7;
  padding: 20px;
}
.card {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 1400px;
  margin: auto;
}
h2 {
  margin-top: 0;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
  vertical-align: top;
}
th {
  background: #1565c0;
  color: #fff;
}
button {
  padding: 6px 10px;
  cursor: pointer;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
</style>
</head>

<body>

<div class="card">
  <div class="header">
    <h2>ðŸ“˜ Penilaian Karakter Siswa</h2>
    <button onclick="downloadPDFAll()">â¬‡ Download PDF Semua</button>
  </div>

  <input type="file" id="fileInput" accept=".xlsx,.xls">

  <table id="tabel">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>NISN</th>
        <th>Rata Nilai</th>
        <th>Skor Karakter</th>
        <th>Deskripsi Karakter</th>
        <th>Kekurangan</th>
        <th>Perbaikan</th>
        <th>PDF</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let dataPDF = [];

/* ==========================
   LOAD EXCEL
========================== */
document.getElementById("fileInput").addEventListener("change", loadExcel);

function loadExcel(e) {
  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    const rows = XLSX.utils.sheet_to_json(sheet, {
      header: 1,
      range: "A8:Y39"
    });

    const tbody = document.querySelector("#tabel tbody");
    tbody.innerHTML = "";
    dataPDF = [];

    rows.forEach((row, i) => {
      if (!row[1]) return;

      const hasil = nilaiKarakterFinal(row);

      dataPDF.push([
        i + 1,
        row[1],
        row[2],
        hasil.rata,
        hasil.skor,
        hasil.karakter,
        hasil.kekurangan,
        hasil.perbaikan
      ]);

      tbody.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${row[1]}</td>
          <td>${row[2]}</td>
          <td>${hasil.rata}</td>
          <td>${hasil.skor}</td>
          <td>${hasil.karakter}</td>
          <td>${hasil.kekurangan}</td>
          <td>${hasil.perbaikan}</td>
          <td><button onclick="downloadPDFSingle(${i})">PDF</button></td>
        </tr>
      `;
    });
  };
  reader.readAsArrayBuffer(e.target.files[0]);
}

/* ==========================
   FUNGSI PENILAIAN FINAL
========================== */
function nilaiKarakterFinal(row) {

  /* --- AKADEMIK (Eâ€“O) --- */
  let total = 0, count = 0;
  for (let i = 4; i <= 14; i++) {
    if (!isNaN(row[i])) {
      total += Number(row[i]);
      count++;
    }
  }
  const rata = count ? (total / count).toFixed(2) : 0;

  let skorAkademik =
    rata >= 90 ? 100 :
    rata >= 80 ? 85 :
    rata >= 70 ? 75 : 60;

  /* --- KEHADIRAN (P,Q,R) --- */
  const sakit = Number(row[15]) || 0;
  const izin  = Number(row[16]) || 0;
  const alpa  = Number(row[17]) || 0;

  let skorHadir =
    alpa === 0 ? 100 :
    alpa <= 2 ? 85 :
    alpa <= 4 ? 75 : 60;

  /* --- EKSTRAKURIKULER (Sâ€“Y) --- */
  let aktifEkskul = 0;
  for (let i = 18; i <= 24; i++) {
    if (row[i]) aktifEkskul++;
  }

  let skorEkskul =
    aktifEkskul >= 2 ? 100 :
    aktifEkskul === 1 ? 80 : 60;

  /* --- SKOR KARAKTER AKHIR --- */
  const skorAkhir = Math.round(
    (0.5 * skorAkademik) +
    (0.3 * skorHadir) +
    (0.2 * skorEkskul)
  );

  /* --- DESKRIPSI --- */
  let karakter = "";
  if (skorAkhir >= 90)
    karakter = "Menunjukkan sikap sangat baik, bertanggung jawab, disiplin, dan aktif dalam kegiatan sekolah.";
  else if (skorAkhir >= 80)
    karakter = "Menunjukkan sikap baik, cukup disiplin, dan bertanggung jawab dalam pembelajaran.";
  else if (skorAkhir >= 70)
    karakter = "Menunjukkan sikap cukup baik, namun masih perlu peningkatan konsistensi.";
  else
    karakter = "Memerlukan pembinaan lebih lanjut dalam kedisiplinan dan tanggung jawab belajar.";

  let kekurangan =
    alpa > 3
      ? "Kedisiplinan dan kehadiran."
      : aktifEkskul === 0
      ? "Keaktifan dan pengembangan minat."
      : "Konsistensi belajar.";

  let perbaikan =
    "Perlu pendampingan belajar, peningkatan disiplin, dan keaktifan dalam kegiatan sekolah.";

  return {
    rata: rata,
    skor: skorAkhir,
    karakter: karakter,
    kekurangan: kekurangan,
    perbaikan: perbaikan
  };
}

/* ==========================
   PDF PER SISWA
========================== */
function downloadPDFSingle(index) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const d = dataPDF[index];

  doc.text("DESKRIPSI KARAKTER SISWA", 14, 15);
  doc.autoTable({
    startY: 25,
    body: [
      ["Nama", d[1]],
      ["NISN", d[2]],
      ["Rata-rata Nilai", d[3]],
      ["Skor Karakter", d[4]],
      ["Deskripsi", d[5]],
      ["Kekurangan", d[6]],
      ["Perbaikan", d[7]]
    ]
  });

  doc.save(d[1] + ".pdf");
}

/* ==========================
   PDF SEMUA SISWA
========================== */
function downloadPDFAll() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l");

  doc.text("REKAP PENILAIAN KARAKTER SISWA", 14, 15);
  doc.autoTable({
    startY: 25,
    head: [["No","Nama","NISN","Rata","Skor","Karakter","Kekurangan","Perbaikan"]],
    body: dataPDF
  });

  doc.save("Rekap_Karakter_Siswa.pdf");
}
</script>

</body>
</html>
